# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
# â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
#    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
#    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• 
#    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     
#    â•šâ•â•   â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•     â•šâ•â•â•â•  â•šâ•â•â•šâ•â•     
#                                                                      
#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
# â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
# â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  
# â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#  â•šâ•â•â•â•â•â• â•šâ•â•      â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•

from TikTokLive import TikTokLiveClient
from TikTokLive.events import ConnectEvent, CommentEvent, GiftEvent, JoinEvent, LikeEvent, ShareEvent, FollowEvent
from colorama import Fore, Style, init
import asyncio
import os
import json
from datetime import datetime
import time
from pyfiglet import Figlet
import threading
from collections import defaultdict
import random
import string
import sqlite3
from typing import Dict, List, Optional, Tuple
import re
import requests
from bs4 import BeautifulSoup

# ======== Cáº¤U HÃŒNH VIP PRO ======== #
init(autoreset=True)
os.system('cls' if os.name == 'nt' else 'clear')

class VIPConfig:
    # ğŸ”§ CÃ i Ä‘áº·t há»‡ thá»‘ng
    LUU_DATABASE = True           # LÆ°u vÃ o SQLite database
    LUU_LOG_JSON = True           # LÆ°u dá»¯ liá»‡u vÃ o file JSON
    AUTO_BACKUP = True            # Tá»± Ä‘á»™ng backup dá»¯ liá»‡u
    MAX_LOG_FILES = 10            # Sá»‘ lÆ°á»£ng file log tá»‘i Ä‘a
    
    # ğŸŒŸ TÃ­nh nÄƒng VIP
    VOICE_READER = False          # Äá»c bÃ¬nh luáº­n báº±ng giá»ng nÃ³i (VIP)
    AUTO_REPLY = True             # Tá»± Ä‘á»™ng tráº£ lá»i bÃ¬nh luáº­n
    ADVANCED_AI_MOD = True        # AI phÃ¡t hiá»‡n spam/bot nÃ¢ng cao
    REAL_TIME_STATS = True        # Hiá»ƒn thá»‹ thá»‘ng kÃª thá»i gian thá»±c
    GIFT_ALERTS = True            # ThÃ´ng bÃ¡o quÃ  táº·ng Ä‘áº·c biá»‡t
    RAIN_MODE = False             # Cháº¿ Ä‘á»™ mÆ°a quÃ  (VIP)
    
    # âš™ï¸ CÃ i Ä‘áº·t hiá»ƒn thá»‹
    HIEN_THI_THOI_GIAN = True     
    TINH_TIEN_QUA = True          
    DEM_GIO = True                
    MAX_COMMENT_LEN = 50          
    HIEN_THI_GIO_BINH_LUAN = True 
    
    # ğŸ”’ Báº£o máº­t
    LOC_TU_KHOA = ["mua acc", "bÃ¡n", "spam", "http", "telegram", "admin", "hack", "cheat"]
    BLOCKED_USERS = []            # Danh sÃ¡ch user bá»‹ cháº·n
    ALLOWED_LANGS = ["vi", "en"]  # NgÃ´n ngá»¯ cho phÃ©p
    
    # ğŸ’ QuÃ  VIP
    VIP_GIFTS = {
        "lion": 299000,
        "galaxy": 199000,
        "universe": 999000,
        "diamond": 50000
    }

# ======== TIá»†N ÃCH VIP ======== #
class VIPUtils:
    @staticmethod
    def generate_id() -> str:
        """Táº¡o ID ngáº«u nhiÃªn cho session"""
        return ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))
    
    @staticmethod
    def tinh_tien_qua(diamond: int) -> str:
        """Chuyá»ƒn kim cÆ°Æ¡ng sang VNÄ vá»›i Ä‘á»‹nh dáº¡ng Ä‘áº¹p"""
        if diamond >= 1000000:
            return f"{diamond/1000000:.1f}M VNÄ"
        elif diamond >= 1000:
            return f"{diamond/1000:.1f}K VNÄ"
        return f"{diamond:,}ğŸ’"
    
    @staticmethod
    def format_thoi_gian(seconds: int) -> str:
        """Äá»‹nh dáº¡ng thá»i gian tá»« giÃ¢y -> HH:MM:SS"""
        hours, remainder = divmod(seconds, 3600)
        minutes, seconds = divmod(remainder, 60)
        return f"{hours:02d}:{minutes:02d}:{seconds:02d}"
    
    @staticmethod
    def rut_gon_text(text: str, max_len: int = 50) -> str:
        """RÃºt gá»n text vá»›i ... náº¿u quÃ¡ dÃ i"""
        if len(text) > max_len:
            return text[:max_len-3] + "..."
        return text
    
    @staticmethod
    def get_user_level(follower_count: int) -> str:
        """XÃ¡c Ä‘á»‹nh level ngÆ°á»i dÃ¹ng theo follower"""
        if follower_count > 1000000:
            return "ğŸ‘‘ SIÃŠU VIP"
        elif follower_count > 500000:
            return "ğŸ’ VIP Äáº¶C BIá»†T"
        elif follower_count > 100000:
            return "â­ VIP"
        elif follower_count > 50000:
            return "ğŸ”¥ PRO"
        elif follower_count > 10000:
            return "ğŸŒ™ Ná»”I TIáº¾NG"
        return "ğŸŒ± Má»šI"

# ======== AI MODERATOR PRO ======== #
class AIModeratorPro:
    def __init__(self):
        self.user_activity = defaultdict(lambda: {'count': 0, 'last_time': 0})
        self.recent_comments = []
        self.bad_words = self.load_bad_words()
        
    def load_bad_words(self) -> List[str]:
        """Táº£i danh sÃ¡ch tá»« khÃ³a nháº¡y cáº£m tá»« file"""
        try:
            with open('bad_words.txt', 'r', encoding='utf-8') as f:
                return [line.strip() for line in f.readlines()]
        except:
            return VIPConfig.LOC_TU_KHOA
    
    def detect_spam(self, user: str, comment: str) -> bool:
        """PhÃ¡t hiá»‡n spam vá»›i thuáº­t toÃ¡n nÃ¢ng cao"""
        now = time.time()
        user_data = self.user_activity[user]
        
        # Reset náº¿u khÃ´ng hoáº¡t Ä‘á»™ng 15s
        if now - user_data['last_time'] > 15:
            user_data['count'] = 0
        
        # Kiá»ƒm tra hÃ nh vi spam
        user_data['count'] += 1
        user_data['last_time'] = now
        
        # 1. QuÃ¡ nhiá»u comment trong thá»i gian ngáº¯n
        if user_data['count'] > 8:
            return True
            
        # 2. Comment giá»‘ng nhau nhiá»u láº§n
        if len(self.recent_comments) > 5 and comment in self.recent_comments[-5:]:
            return True
            
        # 3. Chá»©a tá»« khÃ³a nháº¡y cáº£m
        if any(bad_word in comment.lower() for bad_word in self.bad_words):
            return True
            
        # 4. Link hoáº·c email
        if re.search(r'http[s]?://|www\.|@\S+\.\S+', comment):
            return True
            
        self.recent_comments.append(comment)
        return False

# ======== QUáº¢N LÃ LIVESTREAM PRO ======== #
class LiveManagerPro:
    def __init__(self):
        self.session_id = VIPUtils.generate_id()
        self.start_time = time.time()
        self.stats = {
            'gifts': defaultdict(int),
            'total_value': 0,
            'likes': 0,
            'follows': 0,
            'shares': 0,
            'views': 0,
            'comments': 0
        }
        self.top_donors = {}
        self.gift_history = []
        self.vip_users = set()
        
        if VIPConfig.LUU_DATABASE:
            self.init_database()
    
    def init_database(self):
        """Khá»Ÿi táº¡o database SQLite"""
        self.conn = sqlite3.connect('tiktok_live.db')
        self.cursor = self.conn.cursor()
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS sessions (
                session_id TEXT PRIMARY KEY,
                room_id TEXT,
                start_time TEXT,
                duration INTEGER,
                total_gifts INTEGER,
                total_value INTEGER,
                total_likes INTEGER,
                total_follows INTEGER,
                total_shares INTEGER
            )
        ''')
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS gifts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                session_id TEXT,
                gift_name TEXT,
                gift_value INTEGER,
                sender TEXT,
                timestamp TEXT,
                FOREIGN KEY(session_id) REFERENCES sessions(session_id)
            )
        ''')
        self.conn.commit()
    
    def record_gift(self, gift_name: str, value: int, sender: str):
        """Ghi nháº­n quÃ  táº·ng vÃ o há»‡ thá»‘ng"""
        self.stats['gifts'][gift_name] += value
        self.stats['total_value'] += value
        self.gift_history.append({
            'time': time.time(),
            'gift': gift_name,
            'value': value,
            'sender': sender
        })
        
        # Cáº­p nháº­t top ngÆ°á»i táº·ng
        if sender not in self.top_donors:
            self.top_donors[sender] = 0
        self.top_donors[sender] += value
        
        # Kiá»ƒm tra quÃ  VIP
        if gift_name.lower() in VIPConfig.VIP_GIFTS:
            self.vip_users.add(sender)
            
        # LÆ°u vÃ o database náº¿u enabled
        if VIPConfig.LUU_DATABASE:
            self.cursor.execute('''
                INSERT INTO gifts (session_id, gift_name, gift_value, sender, timestamp)
                VALUES (?, ?, ?, ?, ?)
            ''', (self.session_id, gift_name, value, sender, datetime.now().isoformat()))
            self.conn.commit()
    
    def get_live_duration(self) -> str:
        """Láº¥y thá»i lÆ°á»£ng live"""
        return VIPUtils.format_thoi_gian(int(time.time() - self.start_time))
    
    def get_gifts_per_minute(self, minutes: int = 1) -> List[Dict]:
        """Láº¥y danh sÃ¡ch quÃ  trong N phÃºt gáº§n nháº¥t"""
        cutoff = time.time() - minutes * 60
        return [g for g in self.gift_history if g['time'] >= cutoff]
    
    def save_session(self):
        """LÆ°u thÃ´ng tin session vÃ o database"""
        if not VIPConfig.LUU_DATABASE:
            return
            
        duration = int(time.time() - self.start_time)
        self.cursor.execute('''
            INSERT INTO sessions (
                session_id, room_id, start_time, duration,
                total_gifts, total_value, total_likes,
                total_follows, total_shares
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            self.session_id, client.unique_id,
            datetime.fromtimestamp(self.start_time).isoformat(),
            duration, sum(self.stats['gifts'].values()),
            self.stats['total_value'], self.stats['likes'],
            self.stats['follows'], self.stats['shares']
        ))
        self.conn.commit()

# ======== Há»† THá»NG TÆ¯Æ NG TÃC Tá»° Äá»˜NG ======== #
class AutoInteraction:
    def __init__(self):
        self.last_reply_time = 0
        self.reply_cooldown = 30  # 30s giá»¯a cÃ¡c láº§n reply
        self.common_questions = {
            "hello": "Xin chÃ o báº¡n! Cáº£m Æ¡n Ä‘Ã£ tham gia livestream â¤ï¸",
            "tÃªn gÃ¬": "MÃ¬nh lÃ  Bot trá»£ lÃ½ livestream nha ^^",
            "khá»e khÃ´ng": "MÃ¬nh khá»e láº¯m, cáº£m Æ¡n báº¡n Ä‘Ã£ quan tÃ¢m ğŸ˜Š",
            "káº¿t báº¡n": "Káº¿t báº¡n vá»›i mÃ¬nh qua Facebook nhÃ©: fb.com/example",
            "instagram": "Follow mÃ¬nh trÃªn Instagram @example nhÃ©!",
            "youtube": "ÄÄƒng kÃ½ kÃªnh YouTube cá»§a mÃ¬nh nha: youtube.com/example"
        }
    
    def should_reply(self, comment: str, user: str) -> bool:
        """XÃ¡c Ä‘á»‹nh cÃ³ nÃªn tráº£ lá»i bÃ¬nh luáº­n khÃ´ng"""
        if time.time() - self.last_reply_time < self.reply_cooldown:
            return False
            
        comment_lower = comment.lower()
        for keyword in self.common_questions:
            if keyword in comment_lower:
                return True
                
        # Tráº£ lá»i khi Ä‘Æ°á»£c tag hoáº·c há»i trá»±c tiáº¿p
        if "@bot" in comment_lower or "bot Æ¡i" in comment_lower:
            return True
            
        return False
    
    def generate_reply(self, comment: str) -> str:
        """Táº¡o cÃ¢u tráº£ lá»i tá»± Ä‘á»™ng"""
        comment_lower = comment.lower()
        for keyword, reply in self.common_questions.items():
            if keyword in comment_lower:
                return reply
                
        # Tráº£ lá»i máº·c Ä‘á»‹nh
        replies = [
            "Cáº£m Æ¡n báº¡n Ä‘Ã£ bÃ¬nh luáº­n!",
            "Báº¡n muá»‘n há»i gÃ¬ nÃ o?",
            "MÃ¬nh Ä‘Ã£ ghi nháº­n bÃ¬nh luáº­n cá»§a báº¡n â¤ï¸",
            "Livestream Ä‘ang ráº¥t vui, cÃ¹ng tham gia nhÃ©!",
            "Báº¡n cÃ³ thá»ƒ gá»­i cÃ¢u há»i chi tiáº¿t hÆ¡n khÃ´ng?"
        ]
        return random.choice(replies)

# ======== GIAO DIá»†N VIP ======== #
class VIPInterface:
    @staticmethod
    def show_banner():
        """Hiá»ƒn thá»‹ banner Ä‘áº¹p máº¯t"""
        f = Figlet(font='slant')
        print(Fore.MAGENTA + f.renderText('VIP PRO'))
        print(Fore.CYAN + "â•" * 70)
        print(Fore.YELLOW + "ğŸŒŸ CÃ”NG Cá»¤ THEO DÃ•I TIKTOK LIVE VIP PRO - Báº¢N Äá»˜C QUYá»€N ğŸŒŸ")
        print(Fore.CYAN + "â•" * 70)
        print(Fore.GREEN + "ğŸ”¥ TÃNH NÄ‚NG VIP:")
        print(Fore.WHITE + "  ğŸ‘‘ Há»‡ thá»‘ng AI chá»‘ng spam thÃ´ng minh Ä‘a táº§ng")
        print(Fore.WHITE + "  ğŸ’ Thá»‘ng kÃª quÃ  táº·ng theo thá»i gian thá»±c + Database")
        print(Fore.WHITE + "  ğŸ›¡ï¸ Há»‡ thá»‘ng lá»c tá»« khÃ³a nÃ¢ng cao + User block")
        print(Fore.WHITE + "  ğŸ¤– Tá»± Ä‘á»™ng tráº£ lá»i bÃ¬nh luáº­n thÃ´ng minh")
        print(Fore.WHITE + "  ğŸ“Š BÃ¡o cÃ¡o chi tiáº¿t Ä‘a dáº¡ng + Xuáº¥t Excel")
        print(Fore.WHITE + "  âš¡ Tá»‘i Æ°u hiá»‡u nÄƒng cao cáº¥p")
        print(Fore.CYAN + "â•" * 70 + Style.RESET_ALL)
    
    @staticmethod
    def show_gift_alert(gift_name: str, sender: str, value: int):
        """Hiá»ƒn thá»‹ thÃ´ng bÃ¡o quÃ  VIP"""
        alert_box = [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            f"â•‘   ğŸ  {Fore.YELLOW}QUÃ€ VIP Äáº¶C BIá»†T!{Style.RESET_ALL}   ğŸ  â•‘",
            "â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢",
            f"â•‘ {Fore.CYAN}NgÆ°á»i gá»­i:{Style.RESET_ALL} {sender:<30} â•‘",
            f"â•‘ {Fore.MAGENTA}Loáº¡i quÃ :{Style.RESET_ALL} {gift_name:<30} â•‘",
            f"â•‘ {Fore.GREEN}GiÃ¡ trá»‹:{Style.RESET_ALL} {VIPUtils.tinh_tien_qua(value):<30} â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        ]
        for line in alert_box:
            print(line)
    
    @staticmethod
    def show_real_time_stats(manager: LiveManagerPro):
        """Hiá»ƒn thá»‹ thá»‘ng kÃª thá»i gian thá»±c"""
        duration = manager.get_live_duration()
        total_gifts = sum(manager.stats['gifts'].values())
        total_value = manager.stats['total_value']
        
        stats_box = [
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—",
            f"â•‘   ğŸ“Š  {Fore.YELLOW}THá»NG KÃŠ THá»œI GIAN THá»°C{Style.RESET_ALL}   ğŸ“Š  â•‘",
            "â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢",
            f"â•‘ {Fore.CYAN}Thá»i lÆ°á»£ng:{Style.RESET_ALL} {duration:<30} â•‘",
            f"â•‘ {Fore.MAGENTA}Tá»•ng quÃ :{Style.RESET_ALL} {total_gifts:<30} â•‘",
            f"â•‘ {Fore.GREEN}Tá»•ng giÃ¡ trá»‹:{Style.RESET_ALL} {VIPUtils.tinh_tien_qua(total_value):<30} â•‘",
            f"â•‘ {Fore.BLUE}Likes:{Style.RESET_ALL} {manager.stats['likes']:<30} â•‘",
            f"â•‘ {Fore.CYAN}Theo dÃµi má»›i:{Style.RESET_ALL} {manager.stats['follows']:<30} â•‘",
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        ]
        for line in stats_box:
            print(line)

# ======== KHá»I Táº O Há»† THá»NG ======== #
VIPInterface.show_banner()
room_id = input(Fore.YELLOW + "ğŸ¤ Nháº­p ID TikTok chá»§ phÃ²ng (Bá» @): " + Style.RESET_ALL)

# Khá»Ÿi táº¡o cÃ¡c thÃ nh pháº§n
client = TikTokLiveClient(unique_id=room_id)
manager = LiveManagerPro()
ai_mod = AIModeratorPro()
auto_interact = AutoInteraction() if VIPConfig.AUTO_REPLY else None

# ======== Xá»¬ LÃ Sá»° KIá»†N VIP ======== #
@client.on(ConnectEvent)
async def on_connect(event: ConnectEvent):
    print(f"\n{Fore.GREEN}âœ… ÄÃ£ káº¿t ná»‘i Ä‘áº¿n: {Fore.CYAN}@{event.unique_id}")
    print(f"{Fore.YELLOW}â³ Äang láº¥y dá»¯ liá»‡u live...\n{Fore.CYAN}â•" * 70)
    if VIPConfig.REAL_TIME_STATS:
        threading.Thread(target=show_periodic_stats, daemon=True).start()

@client.on(GiftEvent)
async def on_gift(event: GiftEvent):
    gift = event.gift
    quantity = event.repeat_count if gift.streakable else 1
    total_value = gift.diamond_count * quantity
    
    # Ghi nháº­n quÃ 
    manager.record_gift(gift.name, total_value, event.user.nickname)
    
    # Hiá»ƒn thá»‹ thÃ´ng tin
    time_prefix = f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] " if VIPConfig.HIEN_THI_THOI_GIAN else ""
    value_display = f"{Fore.CYAN}{VIPUtils.tinh_tien_qua(total_value)}" if VIPConfig.TINH_TIEN_QUA else ""
    
    # Kiá»ƒm tra quÃ  VIP
    if gift.name.lower() in VIPConfig.VIP_GIFTS and VIPConfig.GIFT_ALERTS:
        VIPInterface.show_gift_alert(gift.name, event.user.nickname, total_value)
    else:
        print(f"{time_prefix}{Fore.YELLOW}ğŸ {event.user.nickname} "
              f"{Fore.MAGENTA}táº·ng {gift.name} x{quantity} "
              f"{value_display}")

@client.on(CommentEvent)
async def on_comment(event: CommentEvent):
    user = event.user.nickname
    comment = event.comment
    
    # Kiá»ƒm tra spam/bot
    if VIPConfig.ADVANCED_AI_MOD and ai_mod.detect_spam(user, comment):
        time_prefix = f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] " if VIPConfig.HIEN_THI_GIO_BINH_LUAN else ""
        print(f"{time_prefix}{Fore.RED}ğŸš« Bot/Spam: {user}: {VIPUtils.rut_gon_text(comment, VIPConfig.MAX_COMMENT_LEN)}")
        return
    
    # Tá»± Ä‘á»™ng tráº£ lá»i
    if VIPConfig.AUTO_REPLY and auto_interact.should_reply(comment, user):
        reply = auto_interact.generate_reply(comment)
        print(f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] {Fore.GREEN}ğŸ¤– AUTO REPLY: {reply}")
        auto_interact.last_reply_time = time.time()
    
    # Hiá»ƒn thá»‹ bÃ¬nh luáº­n
    time_prefix = f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] " if VIPConfig.HIEN_THI_GIO_BINH_LUAN else ""
    user_level = VIPUtils.get_user_level(event.user.follower_count)
    print(f"{time_prefix}{Fore.BLUE}{user_level} {user}: {Fore.GREEN}{VIPUtils.rut_gon_text(comment, VIPConfig.MAX_COMMENT_LEN)}")

@client.on(LikeEvent)
async def on_like(event: LikeEvent):
    manager.stats['likes'] += event.count
    time_prefix = f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] " if VIPConfig.HIEN_THI_THOI_GIAN else ""
    print(f"{time_prefix}{Fore.YELLOW}â¤ï¸ {event.user.nickname} tháº£ {event.count} like | Tá»•ng: {manager.stats['likes']}")

@client.on(FollowEvent)
async def on_follow(event: FollowEvent):
    manager.stats['follows'] += 1
    time_prefix = f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] " if VIPConfig.HIEN_THI_THOI_GIAN else ""
    print(f"{time_prefix}{Fore.CYAN}âœ¨ {event.user.nickname} Ä‘Ã£ theo dÃµi | Tá»•ng: {manager.stats['follows']}")

@client.on(ShareEvent)
async def on_share(event: ShareEvent):
    manager.stats['shares'] += 1
    time_prefix = f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] " if VIPConfig.HIEN_THI_THOI_GIAN else ""
    print(f"{time_prefix}{Fore.MAGENTA}ğŸ”„ {event.user.nickname} Ä‘Ã£ chia sáº» | Tá»•ng: {manager.stats['shares']}")

@client.on(JoinEvent)
async def on_join(event: JoinEvent):
    time_prefix = f"{Fore.BLACK}[{datetime.now().strftime('%H:%M:%S')}] " if VIPConfig.HIEN_THI_THOI_GIAN else ""
    print(f"{time_prefix}{Fore.GREEN}ğŸ‘‹ {event.user.nickname} Ä‘Ã£ vÃ o phÃ²ng")

# ======== TIá»†N ÃCH Bá»” SUNG ======== #
def show_periodic_stats():
    """Hiá»ƒn thá»‹ thá»‘ng kÃª Ä‘á»‹nh ká»³"""
    while True:
        time.sleep(60)  # Má»—i phÃºt hiá»ƒn thá»‹ 1 láº§n
        if VIPConfig.REAL_TIME_STATS:
            VIPInterface.show_real_time_stats(manager)

def backup_data():
    """Tá»± Ä‘á»™ng backup dá»¯ liá»‡u"""
    if not VIPConfig.AUTO_BACKUP:
        return
        
    backup_dir = "backups"
    os.makedirs(backup_dir, exist_ok=True)
    
    # Backup database
    if VIPConfig.LUU_DATABASE:
        backup_file = os.path.join(backup_dir, f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.db")
        with open(backup_file, 'wb') as f:
            for line in manager.conn.iterdump():
                f.write(f'{line}\n'.encode('utf-8'))
    
    # Backup logs
    if VIPConfig.LUU_LOG_JSON:
        log_data = {
            "session_id": manager.session_id,
            "room_id": room_id,
            "stats": manager.stats,
            "top_donors": dict(sorted(manager.top_donors.items(), key=lambda x: x[1], reverse=True)[:10]),
            "timestamp": datetime.now().isoformat()
        }
        backup_file = os.path.join(backup_dir, f"log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json")
        with open(backup_file, 'w', encoding='utf-8') as f:
            json.dump(log_data, f, indent=4, ensure_ascii=False)

# ======== CHáº Y CHÆ¯Æ NG TRÃŒNH ======== #
if __name__ == "__main__":
    try:
        print(f"\n{Fore.YELLOW}ğŸ”„ Äang káº¿t ná»‘i...{Style.RESET_ALL}")
        
        # Báº¯t Ä‘áº§u cÃ¡c tiáº¿n trÃ¬nh ná»n
        if VIPConfig.AUTO_BACKUP:
            threading.Thread(target=backup_data, daemon=True).start()
        
        client.run()
        
    except KeyboardInterrupt:
        # LÆ°u dá»¯ liá»‡u khi dá»«ng
        manager.save_session()
        if VIPConfig.LUU_DATABASE:
            manager.conn.close()
        
        # Hiá»ƒn thá»‹ bÃ¡o cÃ¡o tá»•ng káº¿t
        print(f"\n{Fore.RED}â›” ÄÃ£ dá»«ng chÆ°Æ¡ng trÃ¬nh")
        print(f"{Fore.CYAN}ğŸ“Š BÃO CÃO Tá»”NG Káº¾T VIP:")
        print(f"â±ï¸ Thá»i lÆ°á»£ng live: {manager.get_live_duration()}")
        print(f"ğŸ Tá»•ng quÃ : {sum(manager.stats['gifts'].values()):,} (Trá»‹ giÃ¡: {VIPUtils.tinh_tien_qua(manager.stats['total_value'])})")
        print(f"â¤ï¸ Tá»•ng like: {manager.stats['likes']:,}")
        print(f"âœ¨ Tá»•ng theo dÃµi má»›i: {manager.stats['follows']:,}")
        print(f"ğŸ”„ Tá»•ng chia sáº»: {manager.stats['shares']:,}")
        
        # Top 3 ngÆ°á»i táº·ng quÃ 
        print(f"\n{Fore.YELLOW}ğŸ† TOP NGÆ¯á»œI Táº¶NG QUÃ€:")
        top_donors = sorted(manager.top_donors.items(), key=lambda x: x[1], reverse=True)[:3]
        for i, (user, amount) in enumerate(top_donors, 1):
            print(f"  {i}. {Fore.CYAN}{user}: {Fore.GREEN}{VIPUtils.tinh_tien_qua(amount)}")
        
        # QuÃ  Ä‘Æ°á»£c táº·ng nhiá»u nháº¥t
        print(f"\n{Fore.MAGENTA}ğŸ¯ QUÃ€ PHá»” BIáº¾N NHáº¤T:")
        top_gifts = sorted(manager.stats['gifts'].items(), key=lambda x: x[1], reverse=True)[:3]
        for gift, count in top_gifts:
            print(f"  - {gift}: {count:,} láº§n")
        
    except Exception as e:
        print(f"\n{Fore.RED}âŒ Lá»–I VIP: {e}")
        if VIPConfig.LUU_DATABASE:
            manager.conn.close()